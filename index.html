<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" id="meta-theme" content="#00853f">
    <link rel="manifest" href="manifest.json">
    <title>Calculateur SÃ©nÃ©gal Pro</title>
    <style>
        :root {
            --primary: #00853f; --primary-dark: #005f2d; --accent: #e31b23;
            --yellow: #fdef42; --bg: #f8fafc; --card-bg: #ffffff;
            --text: #1e293b; --text-light: #64748b; --border: #e2e8f0;
        }

        /* --- SYSTÃˆME DE THÃˆMES (15 COULEURS) --- */
        body.t-blue { --primary: #2563eb; --primary-dark: #1e40af; }
        body.t-red { --primary: #dc2626; --primary-dark: #991b1b; }
        body.t-purple { --primary: #7c3aed; --primary-dark: #5b21b6; }
        body.t-orange { --primary: #f97316; --primary-dark: #c2410c; }
        body.t-pink { --primary: #db2777; --primary-dark: #9d174d; }
        body.t-cyan { --primary: #0891b2; --primary-dark: #155e75; }
        body.t-teal { --primary: #0d9488; --primary-dark: #0f766e; }
        body.t-indigo { --primary: #4f46e5; --primary-dark: #3730a3; }
        body.t-brown { --primary: #78350f; --primary-dark: #451a03; }
        body.t-slate { --primary: #475569; --primary-dark: #1e293b; }
        body.t-lime { --primary: #65a30d; --primary-dark: #3f6212; }
        body.t-gold { --primary: #b45309; --primary-dark: #78350f; }
        body.t-rose { --primary: #e11d48; --primary-dark: #9f1239; }
        body.t-violet { --primary: #8b5cf6; --primary-dark: #6d28d9; }
        body.t-black { --primary: #18181b; --primary-dark: #000000; }

        body.dark-mode { --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc; --text-light: #94a3b8; --border: #334155; }
        
        body { font-family: sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; transition: 0.3s; }
        .container { width: 100%; max-width: 450px; padding-bottom: 100px; }

        .header-card { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 25px; border-radius: 25px; text-align: center; margin-bottom: 20px; transition: 0.5s; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        #moyenne-generale { font-size: 3.5rem; font-weight: 900; color: var(--yellow); margin: 10px 0; }

        .subject-card { background: var(--card-bg); padding: 15px; border-radius: 20px; margin-bottom: 15px; border-left: 5px solid var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .subject-header { display: flex; gap: 10px; margin-bottom: 12px; }
        .subject-header input { background: transparent; color: var(--text); border: none; border-bottom: 2px solid var(--border); font-weight: bold; flex: 1; padding: 5px; }
        
        .notes-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .note-field input { width: 100%; padding: 12px 5px; border: 1px solid var(--border); border-radius: 10px; text-align: center; background: var(--bg); color: var(--text); box-sizing: border-box; font-weight: bold; }

        .btn-calc { width: 100%; padding: 20px; background: var(--primary); color: white; border: none; border-radius: 20px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin: 20px 0; transition: 0.2s; }
        .btn-calc:active { transform: scale(0.98); }

        .top-tools { width: 100%; display: flex; justify-content: space-between; margin-bottom: 15px; }
        .tool-btn { background: var(--card-bg); border: none; border-radius: 12px; width: 45px; height: 45px; font-size: 1.2rem; color: var(--text); cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }

        /* Modals */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10001; justify-content:center; align-items:center; backdrop-filter: blur(5px); }
        .modal-content { background:var(--card-bg); width:85%; max-width:350px; padding:25px; border-radius:25px; text-align:center; position: relative; }
        
        .theme-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin: 20px 0; }
        .color-dot { width: 35px; height: 35px; border-radius: 50%; border: 3px solid white; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .hist-item { padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }

        /* Installation Banner */
        #install-banner { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: var(--card-bg); padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); z-index: 9999; border: 2px solid var(--primary); flex-direction: column; }
    </style>
</head>
<body>

    <div class="container">
        <div class="top-tools">
            <button class="tool-btn" onclick="share()">ðŸ“¤</button>
            <div style="display:flex; gap:8px;">
                <button class="tool-btn" onclick="openModal('modal-themes')">ðŸŽ¨</button>
                <button class="tool-btn" onclick="openModal('modal-history')">ðŸ•’</button>
                <button class="tool-btn" onclick="toggleDark()">ðŸŒ™</button>
            </div>
        </div>

        <div class="header-card">
            <div style="font-size: 0.8rem; font-weight: bold; letter-spacing: 1px;">MOYENNE GÃ‰NÃ‰RALE</div>
            <div id="moyenne-generale">--</div>
            <div id="info-coef" style="font-size: 0.7rem; opacity: 0.8;">Saisissez vos notes</div>
        </div>

        <div id="liste-matieres"></div>
        
        <button class="tool-btn" style="width:100%; border-radius:15px; font-size:0.9rem;" onclick="ajouterMatiere()">+ Ajouter une matiÃ¨re</button>
        <button class="btn-calc" onclick="calculer()">CALCULER MA MOYENNE</button>

        <div onclick="resetApp()" style="text-align:center; color:var(--accent); text-decoration:underline; font-size:0.8rem; cursor:pointer; margin-top:20px;">RÃ©initialiser toute l'application</div>
    </div>

    <div id="modal-themes" class="modal" onclick="closeModal(this)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin-top:0">Choisir un thÃ¨me</h3>
            <div class="theme-grid">
                <div class="color-dot" style="background:#00853f" onclick="setTheme('')"></div>
                <div class="color-dot" style="background:#2563eb" onclick="setTheme('t-blue')"></div>
                <div class="color-dot" style="background:#dc2626" onclick="setTheme('t-red')"></div>
                <div class="color-dot" style="background:#7c3aed" onclick="setTheme('t-purple')"></div>
                <div class="color-dot" style="background:#f97316" onclick="setTheme('t-orange')"></div>
                <div class="color-dot" style="background:#db2777" onclick="setTheme('t-pink')"></div>
                <div class="color-dot" style="background:#0891b2" onclick="setTheme('t-cyan')"></div>
                <div class="color-dot" style="background:#0d9488" onclick="setTheme('t-teal')"></div>
                <div class="color-dot" style="background:#4f46e5" onclick="setTheme('t-indigo')"></div>
                <div class="color-dot" style="background:#78350f" onclick="setTheme('t-brown')"></div>
                <div class="color-dot" style="background:#475569" onclick="setTheme('t-slate')"></div>
                <div class="color-dot" style="background:#65a30d" onclick="setTheme('t-lime')"></div>
                <div class="color-dot" style="background:#b45309" onclick="setTheme('t-gold')"></div>
                <div class="color-dot" style="background:#e11d48" onclick="setTheme('t-rose')"></div>
                <div class="color-dot" style="background:#18181b" onclick="setTheme('t-black')"></div>
            </div>
            <button class="btn-calc" style="margin:0; padding:12px; font-size:0.9rem;" onclick="closeModal(document.getElementById('modal-themes'))">Fermer</button>
        </div>
    </div>

    <div id="modal-history" class="modal" onclick="closeModal(this)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin-top:0">Historique</h3>
            <div id="hist-list" style="max-height:250px; overflow-y:auto; margin-bottom:15px; text-align:left;"></div>
            <button onclick="clearHistory()" style="color:var(--accent); border:none; background:none; text-decoration:underline; cursor:pointer; margin-bottom:15px;">Effacer l'historique</button>
            <button class="btn-calc" style="margin:0; padding:12px; font-size:0.9rem;" onclick="closeModal(document.getElementById('modal-history'))">Fermer</button>
        </div>
    </div>

    <div id="install-banner">
        <p style="margin:0 0 15px 0; font-weight:bold; text-align:center;">Installer l'application sur votre Ã©cran d'accueil ? ðŸ‡¸ðŸ‡³</p>
        <div style="display:flex; gap:10px;">
            <button onclick="ignorerInstallation()" style="flex:1; padding:12px; border-radius:12px; border:none; background:#eee; font-weight:bold;">Plus tard</button>
            <button onclick="lancerInstallation()" style="flex:2; padding:12px; border-radius:12px; border:none; background:var(--primary); color:white; font-weight:bold;">Installer</button>
        </div>
    </div>

<script>
    let matieres = JSON.parse(localStorage.getItem('saved_m')) || [{n:'Maths', c:5, d1:'', d2:'', co:''}];
    let hist = JSON.parse(localStorage.getItem('saved_h')) || [];
    let promptInstallation;

    // --- MISE Ã€ JOUR AUTOMATIQUE ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(reg => {
                reg.onupdatefound = () => {
                    const worker = reg.installing;
                    worker.onstatechange = () => {
                        if (worker.state === 'installed' && navigator.serviceWorker.controller) {
                            showUpdateUI();
                        }
                    };
                };
            });
        });
    }

    function showUpdateUI() {
        const up = document.createElement('div');
        up.style = "position:fixed; bottom:20px; background:var(--primary); color:white; padding:15px; border-radius:15px; z-index:10005; width:90%; left:50%; transform:translateX(-50%); display:flex; justify-content:space-between; align-items:center; font-weight:bold; box-shadow:0 5px 15px rgba(0,0,0,0.3);";
        up.innerHTML = `<span>Mise Ã  jour prÃªte !</span> <button onclick="window.location.reload()" style="background:white; color:var(--primary); border:none; padding:8px 12px; border-radius:8px; font-weight:bold;">Actualiser</button>`;
        document.body.appendChild(up);
    }

    // --- INSTALLATION ---
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        promptInstallation = e;
        if (!localStorage.getItem('install_dismissed')) {
            setTimeout(() => { document.getElementById('install-banner').style.display = 'flex'; }, 4000);
        }
    });

    function lancerInstallation() {
        if (promptInstallation) {
            promptInstallation.prompt();
            document.getElementById('install-banner').style.display = 'none';
        }
    }

    function ignorerInstallation() {
        document.getElementById('install-banner').style.display = 'none';
        localStorage.setItem('install_dismissed', 'true');
    }

    // --- CALCULS & MATIÃˆRES ---
    function render() {
        const container = document.getElementById('liste-matieres');
        container.innerHTML = '';
        matieres.forEach((m, i) => {
            const div = document.createElement('div');
            div.className = 'subject-card';
            div.innerHTML = `
                <div class="subject-header">
                    <input type="text" value="${m.n}" placeholder="MatiÃ¨re" oninput="update(${i}, 'n', this.value)">
                    <input type="number" value="${m.c}" style="width:45px" oninput="update(${i}, 'c', this.value)">
                    <button onclick="remove(${i})" style="border:none; background:none; color:var(--accent); font-weight:bold; font-size:1.2rem;">âœ•</button>
                </div>
                <div class="notes-grid">
                    <input type="number" placeholder="D1" value="${m.d1}" oninput="update(${i}, 'd1', this.value)">
                    <input type="number" placeholder="D2" value="${m.d2}" oninput="update(${i}, 'd2', this.value)">
                    <input type="number" placeholder="Comp" value="${m.co}" oninput="update(${i}, 'co', this.value)">
                </div>`;
            container.appendChild(div);
        });
    }

    function update(i, f, v) { matieres[i][f] = v; localStorage.setItem('saved_m', JSON.stringify(matieres)); }
    function ajouterMatiere() { matieres.push({n:'', c:1, d1:'', d2:'', co:''}); render(); }
    function remove(i) { matieres.splice(i, 1); render(); localStorage.setItem('saved_m', JSON.stringify(matieres)); }

    function calculer() {
        let pts = 0, coefs = 0;
        matieres.forEach(m => {
            let c = parseFloat(m.c) || 0;
            let n1 = parseFloat(m.d1), n2 = parseFloat(m.d2), nc = parseFloat(m.co);
            if(!isNaN(n1) && !isNaN(n2) && !isNaN(nc) && c > 0) {
                pts += (((n1+n2)/2 + nc)/2) * c;
                coefs += c;
            }
        });
        if(coefs > 0) {
            let res = (pts/coefs).toFixed(2);
            document.getElementById('moyenne-generale').innerText = res;
            document.getElementById('info-coef').innerText = "Total Coeff : " + coefs;
            hist.unshift({v: res, d: new Date().toLocaleDateString('fr-FR', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'})});
            localStorage.setItem('saved_h', JSON.stringify(hist.slice(0, 15)));
        } else { alert("Remplissez au moins une matiÃ¨re !"); }
    }

    // --- OUTILS & MODALS ---
    function openModal(id) {
        if(id === 'modal-history') {
            document.getElementById('hist-list').innerHTML = hist.map(h => `<div class="hist-item"><b>${h.v}/20</b> <small>${h.d}</small></div>`).join('') || "Aucun historique";
        }
        document.getElementById(id).style.display = 'flex';
    }
    function closeModal(el) { el.style.display = 'none'; }

    function setTheme(t) {
        document.body.className = t + (document.body.classList.contains('dark-mode') ? ' dark-mode' : '');
        localStorage.setItem('theme-choice', t);
        const color = getComputedStyle(document.body).getPropertyValue('--primary').trim();
        document.getElementById('meta-theme').setAttribute('content', color);
    }

    function toggleDark() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('dark-mode', document.body.classList.contains('dark-mode') ? '1' : '0');
    }

    function clearHistory() { if(confirm("Vider l'historique ?")) { hist=[]; localStorage.setItem('saved_h','[]'); openModal('modal-history'); } }
    function resetApp() { if(confirm("Supprimer TOUTES vos donnÃ©es et matiÃ¨res ?")) { localStorage.clear(); location.reload(); } }
    function share() { if(navigator.share) navigator.share({title:'Calculateur SÃ©nÃ©gal', url: location.href}); }

    // Init
    if(localStorage.getItem('dark-mode') === '1') document.body.classList.add('dark-mode');
    setTheme(localStorage.getItem('theme-choice') || '');
    render();
</script>
</body>
</html>

